# vCPU Hot-plugging

## Overview

vCPU hot-plugging is a new feature that provides Firecracker users with the
flexibility to scale microVMs post-boot. Previously, once a microVM had been
booted, its machine configuration was immutable: the number of vCPUs and amount
of memory could no longer be changed. Now, with hot-plugging, more vCPUs can be
added to a microVM whilst it runs.

## Prerequisites

### x86_64

vCPU hot-plugging uses ACPI methods to enable the new CPUs inside the guest.
Currently, ACPI support is only available for x86_64 machines, and so it follows
that vCPU hot-plugging is only possible on x86_64 for the time being.

### Kconfig

The guest kernel must have the following configuration options enabled for
hot-plugging:

- `CONFIG_HOTPLUG_CPU=y`
- `CONFIG_ACPI_HOTPLUG_CPU=y`
- `CONFIG_ACPI_HOTPLUG_IOAPIC=y`
- `CONFIG_HOTPLUG_SMT=y`

### Udev

The guest operating system must also have the `udev` daemon process running, and
a udev rule suitable for handling hot-plug events. This is to allow the vCPUs to
be brought online automatically after they have been added to the guest. To
check whether `udev` is running on the guest, run the following command:

```
ps ax | grep udevd
```

To check whether there is a rule suitable for handling hot-plug events, run the
following command:

```
ls /usr/lib/udev/rules.d | grep 40-vm-hotadd.rules
```

If no such rule exists, we can create our own rule in the same directory. Below
is a simple rule, that consumes a `uevent` generated by new CPU `kobjects` being
added to `sysfs`, and on-lines new CPUs marked as off-line. For more information
on handling CPU on-lining, and `udev` rules for hot-plug `uevents`, please refer
to the
[kernel documentation on hot-plugging](https://docs.kernel.org/core-api/cpu_hotplug.html).

```
# /usr/lib/udev/rules.d/40-vm-hotadd.rules
SUBSYSTEM=="cpu", ACTION=="add", DEVPATH=="/devices/system/cpu/cpu[0-9]*", TEST=="online", ATTR{online}!="1", ATTR{online}="1"
```

Although `udevd` usually detects rule changes automatically, it sometimes
misses. This can lead to CPUs not being brought on-line after being added. To
prevent this happening, this command can be run to refresh the rules:

```
udevadm control --reload-rules
```

This ensures that `udevd` has the most up to date version of the rule set.

### Booted VM

We recommend waiting until the guest kernel boot process is complete before
making a call to the hot-plug API endpoint. This is because during the hot-plug
operation, Firecracker injects an interrupt into the guest OS to notify it to
re-enumerate CPU devices. During the early stages of the boot process, proper
interrupt handling might not be in place yet, and so if the kernel receives an
interrupt at this time, it may crash due to not being able to handle the
interrupt correctly.

## Implementation

To hot-plug vCPUs, a call can be made to Firecrackerâ€™s `/hotplug` endpoint. The
call should be of the following structure:

```
curl --unix-socket /tmp/firecracker.socket \
    -X PUT 'http://localhost/hotplug' \
    -d '{"Vcpu": {"add": 4}}'
```

The above request will add **4** vCPUs to the microVM. Currently, **Firecracker
supports a maximum of _32 vCPUs_**. Any positive number of vCPUs may be added,
but the number of vCPUs after the request must remain less than 32. Requests
asking for zero vCPUs, a negative number of vCPUs, a floating point number, or a
positive number that would lead to more than 32 vCPUs are invalid, and will
return an error.

Once the API call has been made, Firecracker creates threads for the new vCPUs,
and configures and registers them with KVM. At this point, the host-side work is
complete, and an interrupt is sent to the guest via ACPI to tell the guest to
re-enumerate devices. Once re-enumeration is complete, the vCPUs are visible in
the guest. If a `udev` rule is used, the new vCPUs should immediately appear as
on-line, and be ready to use. If a `udev` rule is not used, the vCPUs will need
to be brought online in a different manner. Read the
[kernel documentation](https://docs.kernel.org/core-api/cpu_hotplug.html) for
more information about on-lining vCPUs.

To check for new vCPUs, run the following command in the guest:

```
lscpu
```

If everything works correctly, the new vCPUs should show up under
`On-line CPU(s) List` if `udev` was used, or `Off-line CPU(s) List` if not.

## Known Issues

These are some issues that we are aware of, that we might not have had the
chance to work on just yet. We are accepting open source submissions on these.

### Sec comp

Currently, vCPU hot-plugging only works properly with seccomp filters disabled.
This can be achieved by supplying the parameter `--no-seccomp` when running the
binary.

### Snapshotting

vCPU hot-plugging after snapshot restore is currently disabled. This is due to
the vCPU config not persisting after restore. Trying to hot-plug vCPUs after a
snapshot restore will return `HotplugVcpuError::RestoredFromSnapshot` until this
has been fixed.

### Hot-unplugging

Hot-unplugging has not yet been implemented.
